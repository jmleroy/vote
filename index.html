<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Simulateur Elections communales Belgique</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <style type="text/css">
        .election th { width: 20% }
        .hidden {display: none;}
        .summary { width: 40%; }
        td > p { margin-bottom:0; }
        nav > form > * { margin-left: 1em; }
    </style>
</head>
<body>

<nav class="navbar mavbar-light">
    <span class="navbar-brand">Élections communales 2018</span>
    <form class="form form-inline">
        <select class="form-control" name="communeName"></select>
        <a href="#" class="resetElection btn btn-danger"><i class="fas fa-trash"></i> Vider tout</a>
        <a href="#" class="resetVotes btn btn-danger"><i class="fas fa-eraser"></i> Effacer chiffres</a>
        <a href="#" class="addList btn btn-primary"><i class="fas fa-plus"></i> Ajouter une liste</a>
    </form>
</nav>

<table class="table election">
  <thead>
    <tr>
      <th></th>
      <th scope="col">Liste</th>
      <th scope="col">Voix</th>
      <th scope="col">Sièges</th>
      <th scope="col">%age</th>
    </tr>
  </thead>
  <tbody>
    <tr class="list">
      <td class="actions">
        <a href="#" class="removeList text-danger hidden"><i class="fas fa-trash-alt"></i></a>
      </td>
      <td>
        <input name="list[]" value="">
        <p class="small hidden">(2012: <span class="previousName"></span>)</p>
      </td>
      <td>
        <input name="votes[]" class="votes" type="number" value="0">
        <p class="small hidden">(2012: <span class="previousVotes"></span>)</p>
      </td>
      <td>
        <p class="seats"></p>
        <p class="small hidden">(2012: <span class="previousSeats"></span>)</p>
      </td>
      <td class="percent"></td>      
    </tr>
  </tbody>
</table>

<table class="table summary">
  <tbody>
    <tr>
      <th scope="row">Nombre total d'électeurs</th>
      <td>
        <input name="maxVotes" value="">
        <p class="small">(2012: <span class="previousMaxVotes"></span>)</p>
      </td>
    </tr>    
    <tr>
      <th scope="row">Nombre de sièges à pourvoir</th>
      <td>
        <input name="maxSeats" value="">
        <p class="small">(2012: <span class="previousMaxSeats"></span>)</p>
      </td>
    </tr>    
    <tr>
      <th scope="row">Votes exprimés</th>
      <td>
        <span class="totalVotes"></span>
        <p class="small">(2012: <span class="previousTotalVotes"></span>)</p>
      </td>
    </tr>
  </tbody>
</table>
<div class="alert-model alert alert-danger hidden" role="alert">
  <span class="message"></span>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
<script type="text/javascript" src="./communes.js"></script>
<script type="text/javascript">
let communeName = 'Héron',
    commune = communes[communeName],
    $communeSelector = $('select[name=communeName]'),
    votes = [],
    seats = [],
    totalVotes = 0,
    maxVotes = 0,
    maxSeats = 0;
const init = function(communeName) {
        commune = communes[communeName];
        $communeSelector.val(communeName);
        let numList = 0, 
            previousTotalVotes = 0;
        $.each(commune.lists, function(listName, listData) {
            if (numList) {
                console.debug('CLICK ' + numList);
                $('.addList').click();
            }
            _setListName(numList, listName);
            _setVotes(numList, listData.previousVotes);
            _setPreviousName(numList, listData.previousName);
            _setPreviousVotes(numList, listData.previousVotes);
            _setPreviousSeats(numList, listData.previousSeats);
            _setColors(numList, listData.backgroundColor, listData.textColor);
            previousTotalVotes += listData.previousVotes;
            numList++;
        });
        $('input[name=maxVotes]').val(commune.maxVotes);
        $('input[name=maxSeats]').val(commune.maxSeats);
        $('.previousMaxVotes').html(commune.previousMaxVotes);
        $('.previousMaxSeats').html(commune.previousMaxSeats);
        $('.previousTotalVotes').html(previousTotalVotes);
        refresh();
    },
    _setListName = function (numList, name) {
        console.debug(numList, name, $('input[name="list[]"]'));
        let inputList = $('input[name="list[]"]')[numList];
        inputList.value = name;
    },
    _setVotes = function (numList, votes) {
        let inputVote = $('input[name="votes[]"]')[numList];
        inputVote.value = votes;
    },
    _setPreviousName = function (numList, name) {
        __setPrevious('previousName', numList, name);
    },
    _setPreviousVotes = function (numList, votes) {
        __setPrevious('previousVotes', numList, parseInt(votes));
    },
    _setPreviousSeats = function (numList, seats) {
        __setPrevious('previousSeats', numList, parseInt(seats));
    },
    __setPrevious = function(what, numList, value) {
        let previousValue = $('.' + what)[numList];
        if (!value || typeof value === 'undefined' || Object.is(value, NaN)) {
            $(previousValue).parent().addClass('hidden');
        } else {
            $(previousValue).parent().removeClass('hidden');
            previousValue.innerHTML = value;
        }
    },
    _setColors = function (numList, backgroundColor, textColor) {
        if (typeof backgroundColor === 'undefined') backgroundColor = 'white';
        if (typeof textColor === 'undefined') textColor = 'black';
        let $list = $($('table.election tr.list')[numList]);
        $list.each(function(index, elem) {
            let td = $(elem).find('td').not('.actions');
            $(td).css('background-color', backgroundColor);
            $(td).css('color', textColor);
            let input = $(td).find('input');
            $(input).css('background-color', textColor);
            $(input).css('color', backgroundColor);
        });
    },
    setTotalVotes = function (t) {
        if (isNaN(parseInt(t))) {
            $('.totalVotes').html('Erreur');
        } else {
            $('.totalVotes').html(t);
        }
    },
    setPercentages = function (totalVotes) {
        $.each(votes, function (list, elem) {
            $('.percent')[list].innerHTML = Math.round((100 * elem) / totalVotes, 2) + '%';
        });
    },
    addDanger = function (message) {
        $('input').addClass('bg-danger');
        $('.totalVotes').addClass('text-danger');
        $('.seats').html(0);
        $('.percent').html('-');
        return addAlert(message);
    },
    removeDanger = function () {
        $('input').removeClass('bg-danger');
        $('.totalVotes').removeClass('text-danger');
        return removeAlert();
    },
    addAlert = function(message) {
        let $alert = $('.alert-message');

        if ($alert.length == 0) {
            $alert = $('.alert-model').clone();
            $alert.removeClass('hidden');
            $alert.removeClass('alert-model');
            $alert.addClass('alert-message');
            $alert.prependTo('body');
        }

        $alert.find('span.message').html(message);
        return true;
    },
    removeAlert = function() {
        $('.alert-message').remove();
        return true;
    },
    resetElection = function (e) {
        if (e) e.preventDefault();

        $('table.election > tbody > tr').each(function (index, elem) { 
            if (index) $(this).remove();
        });
        
        $('input[name="list[]"]').val('');
        $('input[name="votes[]"]').val('');
        $('.previousMaxVotes').html('');
        $('.previousMaxSeats').html('');
        $('.previousTotalVotes').html('');
        $('.totalVotes').html(0);
        _setColors();
    },
    resetVotes = function (e) {
        $('input[name="votes[]"]').val(0);
        refresh();
    },
    refresh = function () {
        votes = [];
        seats = [];
        totalVotes = 0;
        maxVotes = $('input[name=maxVotes]').val() * 1;
        maxSeats = $('input[name=maxSeats]').val() * 1;

        $('input.votes').each(function (list) {
            votes[list] = this.value * 1;
            seats[list] = 0;
        })
        totalVotes = 0;
        $.each(votes, function (k, elem) {
            totalVotes = totalVotes + elem;
        });

        setTotalVotes(totalVotes);
        setPercentages(totalVotes);
        let errorMessage = '';
        if (!totalVotes) {
            errorMessage += 'error totalVotes : ' + totalVotes + '<br>';
        }
        if (!maxVotes) {
            errorMessage += 'error maxVotes : ' + totalVotes + '<br>';
        }
        if (!maxSeats) {
            errorMessage += 'error maxSeats : ' + totalVotes + '<br>';
        }
        if (totalVotes > maxVotes) {
            errorMessage += 'error totalVotes > maxVotes: ' + totalVotes + '>' + maxVotes +'<br>';
        }
        if (errorMessage) {
            return addDanger(errorMessage);
        }

        $.each(getImperiali(votes, maxSeats), function (k, elem) {
            seats[elem.list]++;
        });

        $.each(seats, function (k, elem) {
            $('.seats')[k].innerHTML = elem;
        });

        removeDanger();
    },
    getDHondt = function (votes, maxSeats) {
        return _getQuotient(votes, maxSeats, 1);
    },
    getImperiali = function (votes, maxSeats) {
        return _getQuotient(votes, maxSeats, 2);
    },
    _getQuotient = function (votes, maxSeats, start) {
        let all = [],
            top = [],
            quotient = isNaN(parseInt(start)) ? 1 : start;

        i = 0;
        while (i < maxSeats) {
            $.each(votes, function (list, vote) {
                all[all.length] = {
                    value: vote / (quotient + i),
                    list: list,
                    rank: i
                };
            });
            i++;
        }

        all.sort(function (a, b) {
            return a.value - b.value;
        });

        while (top.length < maxSeats) top[top.length] = all.pop();

        return top;
    }
;

$('input').on('input', function (e) {
    refresh();
});
$('.addList').on('click', function (e) {
    e.preventDefault();
    let listNumber = $('input[name="list[]"]').length;

    $('table.election > tbody > tr.list:last-child').clone(true, true).appendTo('table.election > tbody');
    _setListName(listNumber, 'Liste ' + (listNumber + 1));
    _setVotes(listNumber, 0);
    let newElement = $('table.election > tbody > tr.list:last-child');
    $(newElement).find('.removeList').removeClass('hidden'); // edge case when cloning first line
    
    _setPreviousName(listNumber, '');
    _setPreviousVotes(listNumber, 0);
    _setPreviousSeats(listNumber, 0);
    refresh();
});
$('.removeList').on('click', function (e) {
    e.preventDefault();
    $(this).closest('tr').remove();
    refresh();
});
$('.resetElection').on('click', resetElection);
$('.resetVotes').on('click', resetVotes);

$(document).ready(function () {
    $.each(communes, function(i, c) {
        $communeSelector.append(new Option(i, i));
    });

    $communeSelector.on('change', function(e) {
        resetElection();
        init(this.value);
    });

    $communeSelector.val(communeName);
    init(communeName);
});

</script>
</body>
</html>
