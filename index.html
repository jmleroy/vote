<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Simulateur Elections communales Belgique</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
	<style type="text/css">
		th { width: 20% }
		input { width: 100% }
	</style>
</head>
<body>

<table class="table">
  <thead>
    <tr>
      <th></th>
      <th scope="col"><input class="list" value="Ecolo OuVert"></th>
      <th scope="col"><input class="list" value="EC"></th>
      <th scope="col"><input class="list" value="LB"></th>
      <th scope="col"><input class="list" value="Vous Héron"></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">Voix</th>
      <td><input class="votes" type="number" value="100"></td>
      <td><input class="votes" type="number" value="100"></td>
      <td><input class="votes" type="number" value="100"></td>
      <td><input class="votes" type="number" value="100"></td>
    </tr>
    <tr>
      <th scope="row">Pourcentage</th>
      <td class="percent"></td>
      <td class="percent"></td>
      <td class="percent"></td>
      <td class="percent"></td>
    </tr>
    <tr>
      <th scope="row">Sièges</td>
      <td class="seats"></td>
      <td class="seats"></td>
      <td class="seats"></td>
      <td class="seats"></td>
    </tr>
    <tr>
      <th scope="row">Nombre total d'électeurs</td>
      <td><input name="maxVotes" value="3904"></td>
      <td colspan="3"></td>
    </tr>    
    <tr>
      <th scope="row">Nombre de sièges à pourvoir</td>
      <td><input name="maxSeats" value="17"></td>
      <td colspan="3"></td>
    </tr>    
    <tr>
      <th scope="row">Votes exprimés</td>
      <td class="totalVotes"></td>
      <td colspan="3"></td>
    </tr>
  </tbody>
</table>
<script type="text/javascript">
var votes = {},
	seats = {},
	totalVotes = 0,
	maxVotes = 0,
	maxSeats = 0,
	setTotalVotes = function(t) {
		if (isNaN(parseInt(t))) {
			$('.totalVotes').html('Erreur');
		} else {
			$('.totalVotes').html(t);
		}
	},
	setPercentages = function(totalVotes) {
		$.each(votes, function(list, elem) {
            $('.percent')[list].innerHTML = Math.round((100 * elem) / totalVotes, 2) + '%';
		});
	},
	addDanger = function() {
      $('input').addClass('bg-danger');
      $('.totalVotes').addClass('text-danger');
	},
	removeDanger = function() {
      $('input').removeClass('bg-danger');
      $('.totalVotes').removeClass('text-danger');
	},
    refresh = function() {
      maxVotes = $('input[name=maxVotes]').val() * 1;
      maxSeats = $('input[name=maxSeats]').val() * 1;
      
      $('input.votes').each(function(list) {
        votes[list] = this.value * 1;
        seats[list] = 0;
      })
      totalVotes = 0;
      $.each(votes, function(k, elem) {
      	totalVotes = totalVotes + elem; 
      });

      setTotalVotes(totalVotes);
      setPercentages(totalVotes);
      if (!totalVotes || totalVotes > maxVotes) {
        addDanger();
        $('.seats').html(0);
        $('.percent').html('-');
        return;
      }

      $.each(getImperiali(votes, maxSeats), function(k, elem) {
        seats[elem.list]++;
      });

      $.each(seats, function (k,elem) {
        $('.seats')[k].innerHTML = elem;
      });       

      $('input').removeClass('bg-danger');
    },
    getImperiali = function(votes, maxSeats) {
    	// Calcul
      var top = [];
	  
	  i = 0; 
      	while(i < maxSeats) {
      $.each(votes, function(k, elem) {
      	
      		top[top.length] = {
      			value: Math.round(elem / (i + 1), 0),
      			list: k,
      			rank: i
      		};
      		i++;
      	
      });
      }
      
      top.sort(function(a, b) {
        return b.value - a.value;
      });
      while(top.length > maxSeats) top.pop();

      return top;
    };
    
$('input').on('keyup', function(e) {
	refresh();
});
$(document).ready(function() { refresh(); });

</script>
</body>
</html>
