<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Simulateur Elections communales Belgique</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <style type="text/css">
        .election th { width: 20% }
        .hidden {display: none;}
        .summary { width: 40%; }
        td > p { margin-bottom:0; }
    </style>
</head>
<body>

<table class="table election">
  <thead>
    <tr>
      <th>
        <select name="communeName"></select>
      </th>
      <td scope="col" class="list">
          <input name="list[]" value="">
          <p class="small">(2012: <span class="previousName"></span>)</p>
      </td>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">Voix</th>
      <td>
        <input name="votes[]" class="votes" type="number" value="0">
        <p class="small">(2012: <span class="previousVotes"></span>)</p>
      </td>
    </tr>
    <tr>
      <th scope="row">Pourcentage</th>
      <td class="percent"></td>
    </tr>
    <tr>
      <th scope="row">Sièges</th>
      <td>
        <span class="seats"></span>
        <span class="small">(2012: <span class="previousSeats"></span>)</span>
      </td>
    </tr>
    <tr class="actions">
      <td>
          <a href="#" class="resetElection text-danger"><i class="fas fa-eraser"></i></a>
      </td>
      <td>
          <a href="#" class="removeList text-danger hidden"><i class="fas fa-trash-alt"></i></a>
          <a href="#" class="addList text-primary"><i class="fas fa-plus"></i></a>
      </td>
    </tr>
  </tbody>
</table>
<table class="table summary">
  <tbody>
    <tr>
      <th scope="row">Nombre total d'électeurs</th>
      <td>
        <input name="maxVotes" value="">
        <p class="small">(2012: <span class="previousMaxVotes"></span>)</p>
      </td>
    </tr>    
    <tr>
      <th scope="row">Nombre de sièges à pourvoir</th>
      <td>
        <input name="maxSeats" value="">
        <p class="small">(2012: <span class="previousMaxSeats"></span>)</p>
      </td>
    </tr>    
    <tr>
      <th scope="row">Votes exprimés</th>
      <td>
        <span class="totalVotes"></span>
        <p class="small">(2012: <span class="previousTotalVotes"></span>)</p>
      </td>
    </tr>
  </tbody>
</table>
<div class="alert-model alert alert-danger hidden" role="alert">
  <span class="message"></span>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
<script type="text/javascript" src="./communes.js"></script>
<script type="text/javascript">
let communeName = 'Héron',
    commune = communes[communeName],
    $communeSelector = $('select[name=communeName]'),
    votes = [],
    seats = [],
    totalVotes = 0,
    maxVotes = 0,
    maxSeats = 0;
const init = function(communeName) {
        commune = communes[communeName];
        $communeSelector.val(communeName);
        let numCol = 0, 
            previousTotalVotes = 0;
        $.each(commune.lists, function(listName, listData) {
            if (numCol) {
                $('.addList').click();
            }
            _setListName(numCol, listName);
            _setVotes(numCol, listData.previousVotes);
            _setPreviousName(numCol, listData.previousName);
            _setPreviousVotes(numCol, listData.previousVotes);
            _setPreviousSeats(numCol, listData.previousSeats);
            _setColors(numCol, listData.backgroundColor, listData.textColor);
            previousTotalVotes += listData.previousVotes;
            numCol++;
        });
        $('input[name=maxVotes]').val(commune.maxVotes);
        $('input[name=maxSeats]').val(commune.maxSeats);
        $('.previousMaxVotes').html(commune.previousMaxVotes);
        $('.previousMaxSeats').html(commune.previousMaxSeats);
        $('.previousTotalVotes').html(previousTotalVotes);
        refresh();
    },
    _setListName = function (numCol, name) {
        let inputList = $('input[name="list[]"]')[numCol];
        inputList.value = name;
    },
    _setVotes = function (numCol, votes) {
        let inputVote = $('input[name="votes[]"]')[numCol];
        inputVote.value = votes;
    },
    _setPreviousName = function (numCol, name) {
        __setPrevious('previousName', numCol, name);
    },
    _setPreviousVotes = function (numCol, votes) {
        __setPrevious('previousVotes', numCol, parseInt(votes));
    },
    _setPreviousSeats = function (numCol, seats) {
        __setPrevious('previousSeats', numCol, parseInt(seats));
    },
    __setPrevious = function(what, numCol, value) {
        let previousValue = $('.' + what)[numCol];
        if (typeof value === 'undefined' || Object.is(value, NaN)) {
            $(previousValue).parent().addClass('hidden');
        } else {
            $(previousValue).parent().removeClass('hidden');
            previousValue.innerHTML = value;
        }
    },
    _setColors = function (numCol, backgroundColor, textColor) {
        if (typeof backgroundColor === 'undefined') backgroundColor = 'white';
        if (typeof textColor === 'undefined') textColor = 'white';
        $('table.election tr').each(function(index, elem) {
            if ($(elem).hasClass('actions')) return false;
            let td = $(elem).find('td')[numCol];
            $(td).css('background-color', backgroundColor);
            $(td).css('color', textColor);
            $(td).find('input').css('background-color', textColor);
            $(td).find('input').css('color', backgroundColor);
        });
    },
    setTotalVotes = function (t) {
        if (isNaN(parseInt(t))) {
            $('.totalVotes').html('Erreur');
        } else {
            $('.totalVotes').html(t);
        }
    },
    setPercentages = function (totalVotes) {
        $.each(votes, function (list, elem) {
            $('.percent')[list].innerHTML = Math.round((100 * elem) / totalVotes, 2) + '%';
        });
    },
    addDanger = function (message) {
        $('input').addClass('bg-danger');
        $('.totalVotes').addClass('text-danger');
        $('.seats').html(0);
        $('.percent').html('-');
        return addAlert(message);
    },
    removeDanger = function () {
        $('input').removeClass('bg-danger');
        $('.totalVotes').removeClass('text-danger');
        return removeAlert();
    },
    addAlert = function(message) {
        let $alert = $('.alert-message');

        if ($alert.length == 0) {
            $alert = $('.alert-model').clone();
            $alert.removeClass('hidden');
            $alert.removeClass('alert-model');
            $alert.addClass('alert-message');
            $alert.prependTo('body');
        }

        $alert.find('span.message').html(message);
        return true;
    },
    removeAlert = function() {
        $('.alert-message').remove();
        return true;
    },
    reset = function (e) {
        if (e) e.preventDefault();

        $('.removeList').each(function () { 
            if (!$(this).hasClass('hidden')) {
                this.click(); 
            }
        });
        $('input').val('');
        $('.previousMaxVotes').html('');
        $('.previousMaxSeats').html('');
        $('.previousTotalVotes').html('');
        $('.totalVotes').html(0);
        _setColors();
    },
    refresh = function () {
        votes = [];
        seats = [];
        totalVotes = 0;
        maxVotes = $('input[name=maxVotes]').val() * 1;
        maxSeats = $('input[name=maxSeats]').val() * 1;

        $('input.votes').each(function (list) {
            votes[list] = this.value * 1;
            seats[list] = 0;
        })
        totalVotes = 0;
        $.each(votes, function (k, elem) {
            totalVotes = totalVotes + elem;
        });

        setTotalVotes(totalVotes);
        setPercentages(totalVotes);
        if (!totalVotes || !maxVotes || !maxSeats || totalVotes > maxVotes) {
            return addDanger('error');
        }

        $.each(getImperiali(votes, maxSeats), function (k, elem) {
            seats[elem.list]++;
        });

        $.each(seats, function (k, elem) {
            $('.seats')[k].innerHTML = elem;
        });

        removeDanger();
    },
    getDHondt = function (votes, maxSeats) {
        return _getQuotient(votes, maxSeats, 1);
    },
    getImperiali = function (votes, maxSeats) {
        return _getQuotient(votes, maxSeats, 2);
    },
    _getQuotient = function (votes, maxSeats, start) {
        let all = [],
            top = [],
            quotient = isNaN(parseInt(start)) ? 1 : start;

        i = 0;
        while (i < maxSeats) {
            $.each(votes, function (list, vote) {
                all[all.length] = {
                    value: vote / (quotient + i),
                    list: list,
                    rank: i
                };
            });
            i++;
        }

        all.sort(function (a, b) {
            return a.value - b.value;
        });

        while (top.length < maxSeats) top[top.length] = all.pop();

        return top;
    }
;

$('input').on('input', function (e) {
    refresh();
});
$('.addList').on('click', function (e) {
    e.preventDefault();

    let listNumber = $('table.election > thead > tr > *[scope=col]').length;

    $('table.election tr > *:last-child').each(function(list, elem) {
        let newElement = $(elem).clone(true, true);
        $(newElement).find('input[name="list[]"]').val('Liste ' + (listNumber + 1));
        $(newElement).find('input.votes').val(0);
        $(newElement).find('.removeList').removeClass('hidden'); // edge case with last column remaining
        $($('table.election tr')[list]).append(newElement);
    });

    $(this).remove();
    _setPreviousName(listNumber, '');
    _setPreviousVotes(listNumber, 0);
    _setPreviousSeats(listNumber, 0);
    refresh();
});
$('.removeList').on('click', function (e) {
    e.preventDefault();
    
    let $addList = $(this).siblings('.addList'),
        colNum = $(this).parent().index() + 1;

    if ($addList.length) {
        $addList = $addList.clone(true, true);  
    } 

    $('table.election tr > *:nth-child(' + colNum + ')').remove();

    if ($addList.length) {
        $('tr.actions > *:last-child').append($addList);
    }

    refresh();
});
$('.resetElection').on('click', reset);

$(document).ready(function () {
    $.each(communes, function(i, c) {
        $communeSelector.append(new Option(i, i));
    });

    $communeSelector.on('change', function(e) {
        reset();
        console.debug(e, this.value, $(this).val());
        init(this.value);
    });

    $communeSelector.val(communeName);
    init(communeName);
});

</script>
</body>
</html>
